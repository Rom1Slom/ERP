{% extends 'habilitations_app/base.html' %}
{% load static %}

{% block title %}Détail demande de formation{% endblock %}

{% block page_content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="bi bi-file-earmark-text"></i> Demande de formation
                    </h4>
                    <span class="badge bg-light text-dark">{{ demande.get_statut_display }}</span>
                </div>
                <div class="card-body">
                    <!-- Informations principales -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">Entreprise demandeuse</h6>
                            <p class="fs-5"><strong>{{ demande.entreprise_demandeuse.nom }}</strong></p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">Organisme de formation</h6>
                            <p class="fs-5"><strong>{{ demande.organisme_formation.nom }}</strong></p>
                        </div>
                    </div>

                    <!-- Détails de la formation -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">Type d'habilitation</h6>
                            <p class="fs-5">
                                <span class="badge bg-info">{{ demande.habilitation.code }}</span>
                                {{ demande.habilitation.nom }}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">Nombre de stagiaires</h6>
                            <p class="fs-5"><strong>{{ demande.nombre_stagiaires }}</strong></p>
                        </div>
                    </div>

                    <!-- Préférences de formation -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">Type de formation</h6>
                            <p class="fs-5">
                                {% if demande.type_formation == 'intra' %}
                                    <span class="badge bg-primary">Intra-entreprise</span>
                                    <small class="d-block text-muted mt-1">(sur le site du client)</small>
                                {% elif demande.type_formation == 'inter' %}
                                    <span class="badge bg-secondary">Inter-entreprise</span>
                                    <small class="d-block text-muted mt-1">(chez l'organisme de formation)</small>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">Lieu de formation</h6>
                            <p class="fs-5">
                                {% if demande.lieu_formation == 'sur_site' %}
                                    <i class="bi bi-geo-alt"></i> Sur le site du client
                                {% elif demande.lieu_formation == 'chez_of' %}
                                    <i class="bi bi-building"></i> Au siège de l'OF
                                {% endif %}
                            </p>
                        </div>
                    </div>

                    <!-- Dates -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">Date demandée</h6>
                            <p class="fs-5">{{ demande.date_demande|date:"d/m/Y H:i" }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">Date souhaitée pour la formation</h6>
                            <p class="fs-5">
                                {% if demande.date_souhaitee %}
                                    {{ demande.date_souhaitee|date:"d/m/Y" }}
                                {% else %}
                                    <span class="text-muted">Non précisée</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>

                    <!-- Stagiaires -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">Stagiaires concernés</h6>
                        <div class="list-group">
                            {% for stagiaire in demande.stagiaires.all %}
                                <div class="list-group-item">
                                    <div class="d-flex w-100">
                                        <h6 class="mb-1">{{ stagiaire.nom_complet }}</h6>
                                    </div>
                                    {% if stagiaire.poste %}
                                        <p class="mb-0 text-muted"><small>{{ stagiaire.poste }}</small></p>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Commentaires -->
                    {% if demande.commentaire_demande %}
                        <div class="mb-4">
                            <h6 class="text-muted mb-2">Commentaire de la demande</h6>
                            <div class="alert alert-light border">
                                {{ demande.commentaire_demande|linebreaks }}
                            </div>
                        </div>
                    {% endif %}

                    {% if demande.commentaire_reponse %}
                        <div class="mb-4">
                            <h6 class="text-muted mb-2">Réponse de l'organisme</h6>
                            <div class="alert alert-info">
                                {{ demande.commentaire_reponse|linebreaks }}
                            </div>
                        </div>
                    {% endif %}

                    <!-- Session créée -->
                    {% if demande.session_creee %}
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i> 
                            Demande approuvée et session créée : 
                            <a href="{% url 'detail_session_formation' demande.session_creee.pk %}">
                                {{ demande.session_creee.habilitation.code }} - {{ demande.session_creee.date_debut|date:"d/m/Y" }}
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Actions -->
            <div class="mt-3">
                <a href="{% url 'liste_demandes_formation' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Retour à la liste
                </a>
                {% if est_admin_of and demande.statut == 'en_attente' %}
                    <a href="{% url 'traiter_demande_formation' demande.pk %}" class="btn btn-success">
                        <i class="bi bi-check-circle"></i> Traiter cette demande
                    </a>
                {% endif %}
            </div>
        </div>

        <!-- Informations auxiliaires -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-info-circle"></i> Informations</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6 class="text-muted mb-2">Statut</h6>
                        <p class="mb-0">
                            {% if demande.statut == 'en_attente' %}
                                <span class="badge bg-warning text-dark">En attente de traitement</span>
                            {% elif demande.statut == 'approuvee' %}
                                <span class="badge bg-success">Approuvée</span>
                            {% elif demande.statut == 'refusee' %}
                                <span class="badge bg-danger">Refusée</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ demande.get_statut_display }}</span>
                            {% endif %}
                        </p>
                    </div>

                    {% if demande.traite_par %}
                        <div class="mb-3">
                            <h6 class="text-muted mb-2">Traité par</h6>
                            <p class="mb-0">{{ demande.traite_par.get_full_name|default:demande.traite_par.username }}</p>
                        </div>
                        <div class="mb-3">
                            <h6 class="text-muted mb-2">Date de traitement</h6>
                            <p class="mb-0">{{ demande.date_traitement|date:"d/m/Y H:i"|default:"—" }}</p>
                        </div>
                    {% endif %}

                    <div class="mb-3">
                        <h6 class="text-muted mb-2">Demandeur</h6>
                        <p class="mb-0">{{ demande.demandeur.get_full_name|default:demande.demandeur.username }}</p>
                    </div>

                    {% if demande.consentement_at %}
                        <hr>
                        <small class="text-muted">
                            <i class="bi bi-shield-check"></i> 
                            Consentement enregistré le {{ demande.consentement_at|date:"d/m/Y H:i" }}
                        </small>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
